---
default:
  image: golang:1.25

variables:
  PACKAGE: gitlab.com/davidxarnold/glance
  APPLICATION: kubectl-glance

stages:
- lint
- test
- build
- release

# Run on all branches
lint:
  stage: lint
  image: docker:29
  services:
  - docker:29-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  script:
  - apk add make
  - make lint

test:
  stage: test
  script:
  - make test

# Build all platform binaries
build:
  stage: build
  script:
  # Use tag version if available (strips 'v' prefix), otherwise use version.go
  - |
    if [ -n "$CI_COMMIT_TAG" ]; then
      export RELEASE_VERSION="${CI_COMMIT_TAG#v}"
    fi
    make build-all RELEASE_VERSION="${RELEASE_VERSION:-$(grep 'var Version' version/version.go | cut -d'\"' -f2)}"
    make archive-all RELEASE_VERSION="${RELEASE_VERSION:-$(grep 'var Version' version/version.go | cut -d'\"' -f2)}"
    make checksums RELEASE_VERSION="${RELEASE_VERSION:-$(grep 'var Version' version/version.go | cut -d'\"' -f2)}"
  artifacts:
    paths:
    - target/archives/
    - target/release/
    expire_in: 1 week

# Upload artifacts to Generic Package Registry (permanent storage)
upload-packages:
  stage: release
  image: curlimages/curl:latest
  needs:
  - job: build
    artifacts: true
  rules:
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  script:
  - |
    VERSION="${CI_COMMIT_TAG#v}"
    for file in target/archives/*.tar.gz; do
      filename=$(basename "$file")
      echo "Uploading $filename to package registry..."
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file "$file" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${VERSION}/${filename}"
    done
    # Also upload checksums
    curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
         --upload-file "target/archives/checksums.txt" \
         "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${VERSION}/checksums.txt"

# Create GitLab Release with package registry links (only on tags)
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
  - job: upload-packages
  rules:
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  script:
  - echo "Creating release for ${CI_COMMIT_TAG}"
  variables:
    VERSION: "${CI_COMMIT_TAG#v}"
    PKG_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: |
      ## Glance $CI_COMMIT_TAG

      ### Installation

      **Krew (recommended):**
      ```shell
      kubectl krew install glance
      ```

      **Manual:**
      Download the appropriate archive for your platform below and extract `kubectl-glance` to your PATH.

      ### Checksums
      See checksums.txt for SHA256 hashes.
    assets:
      links:
      - name: "kubectl-glance-${CI_COMMIT_TAG#v}-darwin-amd64.tar.gz"
        url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${CI_COMMIT_TAG#v}/kubectl-glance-${CI_COMMIT_TAG#v}-darwin-amd64.tar.gz"
        link_type: package
      - name: "kubectl-glance-${CI_COMMIT_TAG#v}-darwin-arm64.tar.gz"
        url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${CI_COMMIT_TAG#v}/kubectl-glance-${CI_COMMIT_TAG#v}-darwin-arm64.tar.gz"
        link_type: package
      - name: "kubectl-glance-${CI_COMMIT_TAG#v}-linux-amd64.tar.gz"
        url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${CI_COMMIT_TAG#v}/kubectl-glance-${CI_COMMIT_TAG#v}-linux-amd64.tar.gz"
        link_type: package
      - name: "kubectl-glance-${CI_COMMIT_TAG#v}-linux-arm64.tar.gz"
        url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${CI_COMMIT_TAG#v}/kubectl-glance-${CI_COMMIT_TAG#v}-linux-arm64.tar.gz"
        link_type: package
      - name: "kubectl-glance-${CI_COMMIT_TAG#v}-windows-amd64.tar.gz"
        url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${CI_COMMIT_TAG#v}/kubectl-glance-${CI_COMMIT_TAG#v}-windows-amd64.tar.gz"
        link_type: package
      - name: "checksums.txt"
        url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${CI_COMMIT_TAG#v}/checksums.txt"
        link_type: other

# Update krew manifest and push to repo (only on tags)
update-krew-manifest:
  stage: release
  needs:
  - job: build
    artifacts: true
  rules:
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  before_script:
  - git config --global user.email "${GITLAB_USER_EMAIL}"
  - git config --global user.name "${GITLAB_USER_NAME}"
  - apt-get update && apt-get install -y jq
  # Fetch and checkout the latest main branch before making changes
  - git fetch origin ${CI_DEFAULT_BRANCH}
  - git checkout ${CI_DEFAULT_BRANCH}
  - git reset --hard origin/${CI_DEFAULT_BRANCH}
  script:
  - |
    VERSION=${CI_COMMIT_TAG#v}
    echo "Updating krew manifest for version ${VERSION}"

    # Get checksums
    SHA_DARWIN_AMD64=$(grep darwin-amd64 target/archives/checksums.txt | cut -d' ' -f1)
    SHA_DARWIN_ARM64=$(grep darwin-arm64 target/archives/checksums.txt | cut -d' ' -f1)
    SHA_LINUX_AMD64=$(grep linux-amd64 target/archives/checksums.txt | cut -d' ' -f1)
    SHA_LINUX_ARM64=$(grep linux-arm64 target/archives/checksums.txt | cut -d' ' -f1)
    SHA_WINDOWS_AMD64=$(grep windows-amd64 target/archives/checksums.txt | cut -d' ' -f1)

    echo "Checksums:"
    echo "  darwin-amd64:  ${SHA_DARWIN_AMD64}"
    echo "  darwin-arm64:  ${SHA_DARWIN_ARM64}"
    echo "  linux-amd64:   ${SHA_LINUX_AMD64}"
    echo "  linux-arm64:   ${SHA_LINUX_ARM64}"
    echo "  windows-amd64: ${SHA_WINDOWS_AMD64}"

    # Update manifest
    sed -i "s#version: \"[^\"]*\"#version: \"${VERSION}\"#" plugins/krew/glance.yaml
    sed -i "s#v[0-9]*\.[0-9]*\.[0-9]*#v${VERSION}#g" plugins/krew/glance.yaml
    sed -i "s#PLACEHOLDER_SHA256_DARWIN_AMD64#${SHA_DARWIN_AMD64}#" plugins/krew/glance.yaml
    sed -i "s#PLACEHOLDER_SHA256_DARWIN_ARM64#${SHA_DARWIN_ARM64}#" plugins/krew/glance.yaml
    sed -i "s#PLACEHOLDER_SHA256_LINUX_AMD64#${SHA_LINUX_AMD64}#" plugins/krew/glance.yaml
    sed -i "s#PLACEHOLDER_SHA256_LINUX_ARM64#${SHA_LINUX_ARM64}#" plugins/krew/glance.yaml
    sed -i "s#PLACEHOLDER_SHA256_WINDOWS_AMD64#${SHA_WINDOWS_AMD64}#" plugins/krew/glance.yaml

    # Also update any existing checksums (for re-releases)
    sed -i "s#sha256: \"[a-f0-9]*\"#sha256: \"PLACEHOLDER\"#g" plugins/krew/glance.yaml
    sed -i "s#PLACEHOLDER.*darwin-amd64#${SHA_DARWIN_AMD64}#" plugins/krew/glance.yaml || true

    cat plugins/krew/glance.yaml

    # Commit and push
    git add plugins/krew/glance.yaml
    git commit -m "chore: update krew manifest for ${CI_COMMIT_TAG}" || echo "No changes to commit"
    git push -o ci.skip "https://oauth2:${GL_CI_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git" HEAD:${CI_DEFAULT_BRANCH}
  artifacts:
    paths:
    - plugins/krew/glance.yaml
    expire_in: 1 week

# Optional: Update Homebrew formula (only on tags)
update-formula:
  stage: release
  needs:
  - job: build
    artifacts: true
  rules:
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  before_script:
  - git config --global user.email "${GITLAB_USER_EMAIL}"
  - git config --global user.name "${GITLAB_USER_NAME}"
  # Fetch and checkout the latest main branch before making changes
  - git fetch origin ${CI_DEFAULT_BRANCH}
  - git checkout ${CI_DEFAULT_BRANCH}
  - git reset --hard origin/${CI_DEFAULT_BRANCH}
  script:
  - |
    VERSION=${CI_COMMIT_TAG#v}
    SHA_DARWIN_AMD64=$(grep darwin-amd64 target/archives/checksums.txt | cut -d' ' -f1)

    sed -i "s#sha256 \"[^\"]*\"#sha256 \"${SHA_DARWIN_AMD64}\"#" Formula/glance.rb
    sed -i "s#version \"[^\"]*\"#version \"${VERSION}\"#" Formula/glance.rb

    git add Formula/glance.rb
    git commit -m "chore: update homebrew formula for ${CI_COMMIT_TAG}" || echo "No changes to commit"
    git push -o ci.skip "https://oauth2:${GL_CI_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git" HEAD:${CI_DEFAULT_BRANCH}
