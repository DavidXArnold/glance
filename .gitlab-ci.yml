---
default:
  image: golang:1.25

variables:
  PACKAGE: gitlab.com/davidxarnold/glance
  APPLICATION: kubectl-glance

stages:
- lint
- test
- build
- release

# Run on all branches
lint:
  stage: lint
  image: golangci/golangci-lint:v2.7.2
  script:
  - go mod download
  - golangci-lint run -v --timeout=5m

test:
  stage: test
  script:
  - make test

# Build all platform binaries
build:
  stage: build
  script:
  # Use tag version if available (strips 'v' prefix), otherwise use version.go
  - |
    if [ -n "$CI_COMMIT_TAG" ]; then
      export RELEASE_VERSION="${CI_COMMIT_TAG#v}"
    fi
    make build-all RELEASE_VERSION="${RELEASE_VERSION:-$(grep 'var Version' version/version.go | cut -d'\"' -f2)}"
    make archive-all RELEASE_VERSION="${RELEASE_VERSION:-$(grep 'var Version' version/version.go | cut -d'\"' -f2)}"
    make checksums RELEASE_VERSION="${RELEASE_VERSION:-$(grep 'var Version' version/version.go | cut -d'\"' -f2)}"
  artifacts:
    paths:
    - target/archives/
    - target/release/
    expire_in: 1 week

# Upload artifacts to Generic Package Registry (permanent storage)
upload-packages:
  stage: release
  image: curlimages/curl:latest
  needs:
  - job: build
    artifacts: true
  rules:
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  script:
  - |
    VERSION="${CI_COMMIT_TAG#v}"
    for file in target/archives/*.tar.gz; do
      filename=$(basename "$file")
      echo "Uploading $filename to package registry..."
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file "$file" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${VERSION}/${filename}"
    done
    # Also upload checksums
    curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
         --upload-file "target/archives/checksums.txt" \
         "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${VERSION}/checksums.txt"

# Create GitLab Release with package registry links (only on tags)
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
  - job: upload-packages
  rules:
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  script:
  - |
    VERSION="${CI_COMMIT_TAG#v}"
    echo "Creating release for ${CI_COMMIT_TAG} (version ${VERSION})"
    release-cli create \
      --name "Release ${CI_COMMIT_TAG}" \
      --tag-name "${CI_COMMIT_TAG}" \
      --description "## Glance ${CI_COMMIT_TAG}

    ### Installation

    **Krew (recommended):**
    \`\`\`shell
    kubectl krew install glance
    \`\`\`

    **Manual:**
    Download the appropriate archive for your platform below and extract \`kubectl-glance\` to your PATH.

    ### Checksums
    See checksums.txt for SHA256 hashes." \
      --assets-link "{\"name\":\"kubectl-glance-${VERSION}-darwin-amd64.tar.gz\",\"url\":\"${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${VERSION}/kubectl-glance-${VERSION}-darwin-amd64.tar.gz\",\"link_type\":\"package\"}" \
      --assets-link "{\"name\":\"kubectl-glance-${VERSION}-darwin-arm64.tar.gz\",\"url\":\"${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${VERSION}/kubectl-glance-${VERSION}-darwin-arm64.tar.gz\",\"link_type\":\"package\"}" \
      --assets-link "{\"name\":\"kubectl-glance-${VERSION}-linux-amd64.tar.gz\",\"url\":\"${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${VERSION}/kubectl-glance-${VERSION}-linux-amd64.tar.gz\",\"link_type\":\"package\"}" \
      --assets-link "{\"name\":\"kubectl-glance-${VERSION}-linux-arm64.tar.gz\",\"url\":\"${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${VERSION}/kubectl-glance-${VERSION}-linux-arm64.tar.gz\",\"link_type\":\"package\"}" \
      --assets-link "{\"name\":\"kubectl-glance-${VERSION}-windows-amd64.tar.gz\",\"url\":\"${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${VERSION}/kubectl-glance-${VERSION}-windows-amd64.tar.gz\",\"link_type\":\"package\"}" \
      --assets-link "{\"name\":\"checksums.txt\",\"url\":\"${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kubectl-glance/${VERSION}/checksums.txt\",\"link_type\":\"other\"}"

# Update krew manifest and push to repo (only on tags)
update-krew-manifest:
  stage: release
  needs:
  - job: build
    artifacts: true
  rules:
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  before_script:
  - git config --global user.email "${GITLAB_USER_EMAIL}"
  - git config --global user.name "${GITLAB_USER_NAME}"
  # Fetch and checkout the latest main branch before making changes
  - git fetch origin ${CI_DEFAULT_BRANCH}
  - git checkout ${CI_DEFAULT_BRANCH}
  - git reset --hard origin/${CI_DEFAULT_BRANCH}
  script:
  - |
    VERSION=${CI_COMMIT_TAG#v}
    echo "Updating krew manifest for version ${VERSION}"

    # Get checksums from build artifacts
    SHA_DARWIN_AMD64=$(grep darwin-amd64 target/archives/checksums.txt | cut -d' ' -f1)
    SHA_DARWIN_ARM64=$(grep darwin-arm64 target/archives/checksums.txt | cut -d' ' -f1)
    SHA_LINUX_AMD64=$(grep linux-amd64 target/archives/checksums.txt | cut -d' ' -f1)
    SHA_LINUX_ARM64=$(grep linux-arm64 target/archives/checksums.txt | cut -d' ' -f1)
    SHA_WINDOWS_AMD64=$(grep windows-amd64 target/archives/checksums.txt | cut -d' ' -f1)

    echo "Checksums:"
    echo "  darwin-amd64:  ${SHA_DARWIN_AMD64}"
    echo "  darwin-arm64:  ${SHA_DARWIN_ARM64}"
    echo "  linux-amd64:   ${SHA_LINUX_AMD64}"
    echo "  linux-arm64:   ${SHA_LINUX_ARM64}"
    echo "  windows-amd64: ${SHA_WINDOWS_AMD64}"

    # Update version in spec (krew requires 'v' prefix)
    sed -i 's/version: "[^"]*"/version: "v'"${VERSION}"'"/' plugins/krew/glance.yaml

    # Update version in all URIs (matches patterns like /0.1.8/ and -0.1.8-)
    sed -i 's|/[0-9]\+\.[0-9]\+\.[0-9]\+/kubectl-glance-[0-9]\+\.[0-9]\+\.[0-9]\+-|/'"${VERSION}"'/kubectl-glance-'"${VERSION}"'-|g' plugins/krew/glance.yaml

    # Update checksums for each platform (matches 64-char hex strings after sha256:)
    sed -i '/darwin-amd64\.tar\.gz/{n;s/sha256: [a-f0-9]\{64\}/sha256: '"${SHA_DARWIN_AMD64}"'/}' plugins/krew/glance.yaml
    sed -i '/darwin-arm64\.tar\.gz/{n;s/sha256: [a-f0-9]\{64\}/sha256: '"${SHA_DARWIN_ARM64}"'/}' plugins/krew/glance.yaml
    sed -i '/linux-amd64\.tar\.gz/{n;s/sha256: [a-f0-9]\{64\}/sha256: '"${SHA_LINUX_AMD64}"'/}' plugins/krew/glance.yaml
    sed -i '/linux-arm64\.tar\.gz/{n;s/sha256: [a-f0-9]\{64\}/sha256: '"${SHA_LINUX_ARM64}"'/}' plugins/krew/glance.yaml
    sed -i '/windows-amd64\.tar\.gz/{n;s/sha256: [a-f0-9]\{64\}/sha256: '"${SHA_WINDOWS_AMD64}"'/}' plugins/krew/glance.yaml

    echo "Updated manifest:"
    cat plugins/krew/glance.yaml

    # Commit and push
    git add plugins/krew/glance.yaml
    git commit -m "chore: update krew manifest for ${CI_COMMIT_TAG}" || echo "No changes to commit"
    git push -o ci.skip "https://oauth2:${GL_CI_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git" HEAD:${CI_DEFAULT_BRANCH}
  artifacts:
    paths:
    - plugins/krew/glance.yaml
    expire_in: 1 week

# Sync release to GitHub mirror
release-github:
  stage: release
  image: alpine:latest
  needs:
  - job: upload-packages
  - job: release
  rules:
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  before_script:
  - apk add --no-cache curl
  script:
  - |
    VERSION="${CI_COMMIT_TAG#v}"
    PKG_BASE="https://gitlab.com/api/v4/projects/9502011/packages/generic/kubectl-glance/${VERSION}"
    
    # Check if token is available
    if [ -z "${GITHUB_TOKEN}" ]; then
      echo "ERROR: GITHUB_TOKEN is not set. Check CI/CD variable settings."
      exit 1
    fi
    
    echo "Creating GitHub release for ${CI_COMMIT_TAG}..."
    
    # Build release body with download links (using heredoc to avoid YAML parsing issues)
    BODY=$(cat <<'RELEASE_BODY'
## Glance COMMIT_TAG_PLACEHOLDER

### Installation

**Krew (recommended):**
```shell
kubectl krew install glance
```

### Manual Download

| Platform | Architecture | Download |
|----------|--------------|----------|
| macOS | Intel (amd64) | [kubectl-glance-VERSION_PLACEHOLDER-darwin-amd64.tar.gz](PKG_BASE_PLACEHOLDER/kubectl-glance-VERSION_PLACEHOLDER-darwin-amd64.tar.gz) |
| macOS | Apple Silicon (arm64) | [kubectl-glance-VERSION_PLACEHOLDER-darwin-arm64.tar.gz](PKG_BASE_PLACEHOLDER/kubectl-glance-VERSION_PLACEHOLDER-darwin-arm64.tar.gz) |
| Linux | amd64 | [kubectl-glance-VERSION_PLACEHOLDER-linux-amd64.tar.gz](PKG_BASE_PLACEHOLDER/kubectl-glance-VERSION_PLACEHOLDER-linux-amd64.tar.gz) |
| Linux | arm64 | [kubectl-glance-VERSION_PLACEHOLDER-linux-arm64.tar.gz](PKG_BASE_PLACEHOLDER/kubectl-glance-VERSION_PLACEHOLDER-linux-arm64.tar.gz) |
| Windows | amd64 | [kubectl-glance-VERSION_PLACEHOLDER-windows-amd64.tar.gz](PKG_BASE_PLACEHOLDER/kubectl-glance-VERSION_PLACEHOLDER-windows-amd64.tar.gz) |

### Checksums

[checksums.txt](PKG_BASE_PLACEHOLDER/checksums.txt)

### Full Release Notes

See [GitLab Release](https://gitlab.com/davidxarnold/glance/-/releases/COMMIT_TAG_PLACEHOLDER) for additional details.
RELEASE_BODY
)
    # Replace placeholders with actual values
    BODY="${BODY//COMMIT_TAG_PLACEHOLDER/${CI_COMMIT_TAG}}"
    BODY="${BODY//VERSION_PLACEHOLDER/${VERSION}}"
    BODY="${BODY//PKG_BASE_PLACEHOLDER/${PKG_BASE}}"

    # Escape for JSON
    BODY_JSON=$(printf '%s' "$BODY" | sed 's/\\/\\\\/g; s/"/\\"/g' | awk '{printf "%s\\n", $0}' | sed 's/\\n$//')
    
    # Create GitHub release via API
    HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" -X POST \
      -H "Authorization: Bearer ${GITHUB_TOKEN}" \
      -H "Accept: application/vnd.github+json" \
      -H "X-GitHub-Api-Version: 2022-11-28" \
      https://api.github.com/repos/davidxarnold/glance/releases \
      -d "{
        \"tag_name\": \"${CI_COMMIT_TAG}\",
        \"name\": \"Release ${CI_COMMIT_TAG}\",
        \"body\": \"${BODY_JSON}\",
        \"draft\": false,
        \"prerelease\": false
      }")
    
    echo "HTTP response code: ${HTTP_CODE}"
    cat response.json
    
    if [ "${HTTP_CODE}" -ge 400 ]; then
      echo "ERROR: GitHub API returned ${HTTP_CODE}"
      exit 1
    fi
    
    echo "GitHub release created successfully!"
